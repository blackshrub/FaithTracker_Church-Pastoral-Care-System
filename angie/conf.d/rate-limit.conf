# ===========================================
# FaithTracker - Rate Limiting Configuration
# ===========================================
# Protects against DDoS and brute force attacks
# Migrated from Traefik rate limiting middleware
#
# Traefik original values:
#   - General: 500 avg/200 burst per minute (~8.3 req/s)
#   - Auth: 200 avg/100 burst per minute (~3.3 req/s)
#   - Frontend: 200 avg/100 burst per minute (~3.3 req/s)
#   - In-flight requests: 50 per IP

# ===================
# Rate Limit Zones
# ===================

# API rate limit zone
# ~10 requests per second (600/min = 10/s)
# Slightly higher than Traefik's 500/min to be generous
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Auth endpoint rate limit zone (stricter)
# ~3 requests per second (180/min = 3/s)
# Prevents brute force login attempts
limit_req_zone $binary_remote_addr zone=auth:10m rate=3r/s;

# Frontend rate limit zone
# ~5 requests per second (300/min = 5/s)
limit_req_zone $binary_remote_addr zone=frontend:10m rate=5r/s;

# ===================
# Connection Limit Zones
# ===================

# Limit concurrent connections per IP
# Prevents slowloris and connection exhaustion attacks
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ===================
# Rate Limit Settings
# ===================

# Status code for rate-limited requests
limit_req_status 429;
limit_conn_status 429;

# Log rate limiting
limit_req_log_level warn;
limit_conn_log_level warn;

# ===================
# Usage Notes
# ===================
# Apply rate limits in location blocks:
#
#   # Standard API endpoint
#   limit_req zone=api burst=100 nodelay;
#
#   # Auth endpoint (stricter)
#   limit_req zone=auth burst=10 nodelay;
#
#   # Connection limit
#   limit_conn conn_limit 50;
#
# The 'burst' parameter allows temporary spikes
# The 'nodelay' parameter processes burst requests immediately
# without queuing (fails immediately if over limit)
