# FaithTracker Docker Compose
# Production deployment with Angie (host-level reverse proxy)
#
# Architecture:
#   - Angie runs at HOST level (handles SSL, rate limiting, security)
#   - All application services run in Docker containers
#   - Services exposed to localhost only (127.0.0.1)
#   - Data stored in ./data/ directory (bind mounts for easy migration)
#
# Setup:
#   1. Install Angie: sudo ./angie/install.sh
#   2. Setup SSL: sudo ./angie/setup-ssl.sh
#   3. Start services: docker compose up -d
#
# Migration:
#   Copy entire project folder (including ./data/) to new server

services:
  # ===================
  # MongoDB Database
  # ===================
  mongo:
    image: mongo:7.0
    container_name: faithtracker-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: faithtracker
    volumes:
      - ./data/mongo:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - faithtracker-network
    # Resource limits to prevent runaway memory/CPU usage
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===================
  # Backend - FastAPI/Litestar
  # ===================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: faithtracker-backend
    restart: unless-stopped
    # Expose to localhost only (Angie will proxy)
    ports:
      - "127.0.0.1:8001:8001"
    environment:
      - ENVIRONMENT=production
      - MONGO_URL=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD}@mongo:27017/faithtracker?authSource=admin
      - DB_NAME=faithtracker
      - JWT_SECRET_KEY=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - FRONTEND_URL=https://${DOMAIN}
      - ALLOWED_ORIGINS=https://${DOMAIN},https://api.${DOMAIN}
      - WHATSAPP_GATEWAY_URL=${WHATSAPP_GATEWAY_URL:-}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      - ADMIN_PHONE=${ADMIN_PHONE:-}
    volumes:
      - ./data/uploads:/app/uploads
    networks:
      - faithtracker-network
    depends_on:
      mongo:
        condition: service_healthy
    # Resource limits to prevent runaway memory/CPU usage
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ===================
  # Frontend - React (Nginx)
  # ===================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_BACKEND_URL: https://api.${DOMAIN}
    container_name: faithtracker-frontend
    restart: unless-stopped
    # Expose to localhost only (Angie will proxy)
    ports:
      - "127.0.0.1:8080:80"
    networks:
      - faithtracker-network
    depends_on:
      - backend
    # Resource limits to prevent runaway memory/CPU usage
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ===================
# Networks
# ===================
networks:
  faithtracker-network:
    name: faithtracker-network
    driver: bridge

# ===================
# Data Directories (Bind Mounts)
# ===================
# Data is stored in ./data/ directory for easy backup and migration:
#   - ./data/mongo    - MongoDB database files
#   - ./data/uploads  - User-uploaded files (member photos)
#
# To migrate to a new server, simply copy the entire project folder
# including the ./data/ directory.
